#!/bin/bash

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ัะบัะธะฟัะฐ
cd "$(dirname "$0")"

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}   ะะฐะฟััะบ Telegram AI Request Processor${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

# ะัะพะฒะตัะบะฐ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d "venv" ]; then
    echo -e "${RED}โ ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ!${NC}"
    echo -e "${YELLOW}ะกะพะทะดะฐะนัะต ะตะณะพ ะบะพะผะฐะฝะดะพะน: python3 -m venv venv${NC}"
    exit 1
fi

# ะัะพะฒะตัะบะฐ .env ัะฐะนะปะฐ
if [ ! -f ".env" ]; then
    echo -e "${RED}โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!${NC}"
    echo -e "${YELLOW}ะกะบะพะฟะธััะนัะต .env.example ะฒ .env ะธ ะทะฐะฟะพะปะฝะธัะต ะฝะฐัััะพะนะบะธ${NC}"
    exit 1
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
source venv/bin/activate
export PYTHONPATH=".:${PYTHONPATH}"

# ะะฐััะธะฒ ะดะปั ััะฐะฝะตะฝะธั PID ะฟัะพัะตััะพะฒ
PIDS=()

# ะคัะฝะบัะธั ะดะปั ะทะฐะฒะตััะตะฝะธั ะฒัะตั ะฟัะพัะตััะพะฒ
cleanup() {
    echo -e "\n${YELLOW}ะััะฐะฝะพะฒะบะฐ ะฒัะตั ะฟัะพัะตััะพะฒ...${NC}"
    for pid in "${PIDS[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
        fi
    done
    echo -e "${GREEN}โ ะัะต ะฟัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั${NC}"
    exit 0
}

# ะะฑัะฐะฑะพัะบะฐ Ctrl+C
trap cleanup SIGINT SIGTERM

echo ""
echo -e "${GREEN}๐ ะะฐะฟััะบ ะบะพะผะฟะพะฝะตะฝัะพะฒ...${NC}"
echo ""

# ะัะฒะพะฑะพะถะดะตะฝะธะต ะฟะพััะฐ 8000 ะตัะปะธ ะทะฐะฝัั
if lsof -i:8000 -t >/dev/null ; then
    echo -e "${YELLOW}โ๏ธ ะะพัั 8000 ะทะฐะฝัั. ะัะฒะพะฑะพะถะดะฐะตะผ...${NC}"
    kill -9 $(lsof -i:8000 -t) 2>/dev/null
fi

# ะะฐะฟััะบ ะฑะพัะฐ
echo -e "${BLUE}[1/2]${NC} ะะฐะฟััะบ ะะปะตะบัะตั (Userbot)..."
# ะัะธััะธะผ ะปะพะณ ะฟะตัะตะด ะทะฐะฟััะบะพะผ, ััะพะฑั ะฝะต ัะธัะฐัั ััะฐััะต ะทะฐะฟะธัะธ
> logs/alexey.log
python3 -m systems.alexey.main > logs/alexey.log 2>&1 &
BOT_PID=$!
PIDS+=($BOT_PID)

echo -e "${YELLOW}โณ ะะถะธะดะฐะฝะธะต ะฟะพะปะฝะพะน ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะะปะตะบัะตั...${NC}"

# ะะถะธะดะฐะฝะธะต ะณะพัะพะฒะฝะพััะธ (ะผะฐะบัะธะผัะผ 30 ัะตะบัะฝะด)
MAX_RETRIES=30
COUNT=0
ALEXEY_READY=false

while [ $COUNT -lt $MAX_RETRIES ]; do
    if grep -q "Userbot is running" logs/alexey.log; then
        ALEXEY_READY=true
        break
    fi
    
    # ะัะพะฒะตัะบะฐ, ะฝะต ัะฟะฐะป ะปะธ ะฟัะพัะตัั
    if ! kill -0 $BOT_PID 2>/dev/null; then
        echo -e "${RED}โ ะัะพัะตัั ะะปะตะบัะตั ะทะฐะฒะตััะธะปัั ะฝะตะพะถะธะดะฐะฝะฝะพ!${NC}"
        tail -n 20 logs/alexey.log
        cleanup
    fi
    
    sleep 1
    COUNT=$((COUNT+1))
done

if [ "$ALEXEY_READY" = true ]; then
    echo -e "${GREEN}  โ ะะปะตะบัะตะน ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ ะธ ะณะพัะพะฒ ะบ ัะฐะฑะพัะต (PID: $BOT_PID)${NC}"
else
    echo -e "${RED}  โ ะขะฐะนะผ-ะฐัั ะพะถะธะดะฐะฝะธั ะทะฐะฟััะบะฐ ะะปะตะบัะตั${NC}"
    tail -n 20 logs/alexey.log
    cleanup
fi

# ะะฐะฟััะบ ะฒะตะฑ-ะดะฐัะฑะพัะดะฐ (ัะพะปัะบะพ ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ััะฐััะฐ ะะปะตะบัะตั)
echo -e "${BLUE}[2/2]${NC} ะะฐะฟััะบ ะะฐัะฑะพัะดะฐ..."
python3 systems/dashboard/main.py > logs/dashboard.log 2>&1 &
WEB_PID=$!
PIDS+=($WEB_PID)
sleep 2

if kill -0 $WEB_PID 2>/dev/null; then
    echo -e "${GREEN}  โ ะะฐัะฑะพัะด ะทะฐะฟััะตะฝ (PID: $WEB_PID)${NC}"
else
    echo -e "${RED}  โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะะฐัะฑะพัะดะฐ${NC}"
    tail -n 20 logs/dashboard.log
    cleanup
fi

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะัะต ัะธััะตะผั ะทะฐะฟััะตะฝั ััะฟะตัะฝะพ!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${BLUE}๐ ะะตะฑ-ะธะฝัะตััะตะนั:${NC} http://localhost:8000"
echo -e "${BLUE}๐ฑ Telegram App:${NC}  http://localhost:8000/twa"
echo -e "${BLUE}๐ ะะพะณะธ ะะปะตะบัะตั:${NC}     tail -f logs/alexey.log"
echo -e "${BLUE}๐ ะะพะณะธ ะะฐัะฑะพัะดะฐ:${NC}    tail -f logs/dashboard.log"
echo ""
echo -e "${YELLOW}ะะฐะถะผะธัะต Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ ะฒัะตั ะฟัะพัะตััะพะฒ${NC}"
echo ""

# ะะถะธะดะฐะฝะธะต ะทะฐะฒะตััะตะฝะธั
wait
